<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sopa de letras IOA - interactiva</title>
<style>
  body{font-family: Arial, Helvetica, sans-serif; background:#f4f4f4; margin:0; padding:20px; text-align:center;}
  h1{margin:0 0 10px}
  #container{display:flex;flex-direction:row;gap:30px;justify-content:center;align-items:flex-start;flex-wrap:wrap}
  #left{max-width:460px;text-align:left}
  #word-list{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.12);margin-bottom:12px}
  #controls{margin-top:8px}
  #grid-wrap{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.12)}
  table{border-collapse:collapse;margin:auto; user-select:none}
  td{width:34px;height:34px;border:1px solid #cfcfcf; text-align:center; vertical-align:middle; font-weight:700; font-size:18px; cursor:pointer; background:white}
  td.selected{background:#ffd86b}
  td.found{background:#52b788;color:white}
  .found-word{text-decoration:line-through;color:green;font-weight:700}
  button{padding:8px 12px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer}
  small{color:#555}
  @media (max-width:820px){
    #container{flex-direction:column;align-items:center}
  }
</style>
</head>
<body>
  <h1>Sopa de letras – Depósitos IOA</h1>
  <div id="container">
    <div id="left">
      <div id="word-list">
        <strong>Palabras a encontrar</strong>
        <ul id="wordsUl">
          <!-- Lista se genera desde JS -->
        </ul>
        <div id="controls">
          <button id="newBtn">Generar otra distribución</button>
          <button id="revealBtn">Mostrar solución</button>
          <button id="hideBtn" style="display:none">Ocultar solución</button>
          <div style="margin-top:8px"><small>Selecciona arrastrando (o clic) para formar palabras.</small></div>
        </div>
      </div>
      <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.12)">
        <strong>Instrucciones</strong>
        <ol>
          <li>Selecciona con el mouse o el dedo (clic y arrastra) las letras de una palabra.</li>
          <li>La palabra se marcará en verde si es correcta.</li>
          <li>Pulsa "Generar otra distribución" si prefieres una nueva posición de palabras.</li>
        </ol>
      </div>
    </div>

    <div id="grid-wrap">
      <div id="status" style="margin-bottom:8px"><strong id="foundCount">0</strong> / <strong id="totalCount">0</strong> palabras encontradas</div>
      <div id="board"></div>
    </div>
  </div>

<script>
/* ------------ Lista de palabras (tal y como se mostrarán) -------------- */
const displayWords = [
  "HIDROTERMAL",
  "EL LACO",
  "HIERRO",
  "ALBITIZACION",
  "APATITO",
  "CLINOZOISITA",
  "MAGNETITA",
  "HEMATITA",
  "ACTINOLITA",
  "SUBDUCCION",
  "ARCOVOLCANICO",
  "ALTERACION",
  "PROPILITICA",
  "CALCOSODICA",
  "METASOMATISMO",
  "BRECHAS"
];

/* --------- Normalizar palabra para buscar (quitar espacios, tildes y pasar a mayúsculas) -------- */
function normalizeWord(w){
  // eliminar espacios y tildes (aunque las palabras no trae tildes)
  const specialMap = {'Á':'A','É':'E','Í':'I','Ó':'O','Ú':'U','Ñ':'N'};
  let s = w.toUpperCase().replace(/\s+/g,'');
  s = s.split('').map(ch => specialMap[ch] || ch).join('');
  return s;
}

/* ---------------- Parámetros del tablero ---------------- */
const SIZE = 20; // 20x20
let grid; // matriz [r][c] con letras
let placement = []; // objetos de palabras colocadas
const directions = [
  {dr:0,dc:1},  {dr:0,dc:-1}, // horizontal
  {dr:1,dc:0},  {dr:-1,dc:0}, // vertical
  {dr:1,dc:1},  {dr:1,dc:-1}, {dr:-1,dc:1}, {dr:-1,dc:-1} // diagonales
];

/* Inicializa lista visual */
const wordsUl = document.getElementById('wordsUl');
displayWords.forEach(w=>{
  let li = document.createElement('li');
  li.textContent = w;
  li.id = 'li-' + normalizeWord(w);
  wordsUl.appendChild(li);
});

/* generar tablero vacío */
function makeEmptyGrid(){
  grid = Array.from({length:SIZE}, _ => Array.from({length:SIZE}, _ => ''));
}

/* intentar posicionar todas las palabras en el tablero */
function placeAllWords(){
  placement = [];
  const normWords = displayWords.map(w => ({display:w, word: normalizeWord(w)}));
  // ordenar por largo descendente para facilitar colocación
  normWords.sort((a,b)=>b.word.length - a.word.length);

  for(const item of normWords){
    const word = item.word;
    let placed = false;
    let attempts = 0;
    while(!placed && attempts < 400){
      attempts++;
      const dir = directions[Math.floor(Math.random()*directions.length)];
      const r0 = Math.floor(Math.random()*SIZE);
      const c0 = Math.floor(Math.random()*SIZE);
      // calcular fin
      const r1 = r0 + dir.dr*(word.length-1);
      const c1 = c0 + dir.dc*(word.length-1);
      if(r1 < 0 || r1 >= SIZE || c1 < 0 || c1 >= SIZE) continue; // fuera
      // comprobar conflicto
      let ok = true;
      for(let k=0;k<word.length;k++){
        const r = r0 + dir.dr*k;
        const c = c0 + dir.dc*k;
        const ch = grid[r][c];
        if(ch !== '' && ch !== word[k]) { ok = false; break; }
      }
      if(!ok) continue;
      // colocar
      for(let k=0;k<word.length;k++){
        const r = r0 + dir.dr*k;
        const c = c0 + dir.dc*k;
        grid[r][c] = word[k];
      }
      placement.push({word:word, display:item.display, r0,c0,dr:dir.dr,dc:dir.dc});
      placed = true;
    }
    if(!placed){
      // Si falla la colocación reiniciamos todo y lo intentamos de nuevo (simple estrategia)
      return false;
    }
  }
  return true;
}

/* rellenar con letras aleatorias */
function fillRandom(){
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      if(grid[r][c] === '') grid[r][c] = letters[Math.floor(Math.random()*letters.length)];
    }
  }
}

/* generar una disposición válida */
function generateValid(){
  let tries = 0;
  do {
    makeEmptyGrid();
    tries++;
    var ok = placeAllWords();
  } while(!ok && tries < 60);
  if(!ok) {
    alert("No se pudo generar la sopa en este intento. Intenta Generar otra distribución.");
    return;
  }
  fillRandom();
  renderGrid();
  document.getElementById('totalCount').textContent = displayWords.length;
  document.getElementById('foundCount').textContent = 0;
  // reset visual list
  displayWords.forEach(w=>{
    const id = 'li-' + normalizeWord(w);
    const el = document.getElementById(id);
    if(el) el.classList.remove('found-word');
  });
}

/* renderizar la cuadrícula en HTML y activar eventos */
function renderGrid(){
  const board = document.getElementById('board');
  board.innerHTML = '';
  const table = document.createElement('table');
  table.id = 'puzzleTable';
  table.style.borderSpacing = '0';
  for(let r=0;r<SIZE;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<SIZE;c++){
      const td = document.createElement('td');
      td.textContent = grid[r][c];
      td.dataset.r = r; td.dataset.c = c;
      td.dataset.char = grid[r][c];
      td.className = '';
      // eventos para seleccionar
      td.addEventListener('mousedown', onMouseDown);
      td.addEventListener('mouseenter', onMouseEnter);
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  board.appendChild(table);
}

/* selección interactividad */
let isSelecting = false;
let selectedCells = [];

function onMouseDown(e){
  e.preventDefault();
  clearSelectionVisual();
  isSelecting = true;
  selectedCells = [];
  addCellToSelection(e.target);
}

function onMouseEnter(e){
  if(!isSelecting) return;
  addCellToSelection(e.target);
}

document.addEventListener('mouseup', ()=>{
  if(!isSelecting) return;
  isSelecting = false;
  checkSelection();
});

/* touch support */
document.addEventListener('touchstart', (e)=>{
  const target = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
  if(target && target.tagName === 'TD'){ e.preventDefault(); onMouseDown({target}); }
}, {passive:false});
document.addEventListener('touchmove', (e)=>{
  const target = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
  if(target && target.tagName === 'TD') onMouseEnter({target});
}, {passive:false});
document.addEventListener('touchend', ()=>{
  if(isSelecting){ isSelecting=false; checkSelection(); }
});

/* añadir celda a la selección */
function addCellToSelection(td){
  if(!td || td.tagName !== 'TD') return;
  // evitar duplicados
  if(selectedCells.includes(td)) return;
  td.classList.add('selected');
  selectedCells.push(td);
}

/* limpiar selección visual (sin marcar encontradas) */
function clearSelectionVisual(){
  document.querySelectorAll('td.selected').forEach(td=>td.classList.remove('selected'));
  selectedCells = [];
}

/* chequear palabra formada */
function checkSelection(){
  if(selectedCells.length === 0) return;
  const formed = selectedCells.map(td=>td.textContent).join('').toUpperCase();
  const formedRev = formed.split('').reverse().join('');
  // comparar con las palabras normalizadas
  for(const item of placement){
    const w = item.word.toUpperCase();
    if(formed === w || formedRev === w){
      // marcar como encontrada (evitar recontar si ya marcada)
      const li = document.getElementById('li-' + w);
      if(li && !li.classList.contains('found-word')){
        li.classList.add('found-word');
        // colorear celdas seleccionadas como found
        selectedCells.forEach(td=>{ td.classList.remove('selected'); td.classList.add('found'); });
        // marcar número encontrado
        const foundNow = document.querySelectorAll('.found-word').length;
        document.getElementById('foundCount').textContent = foundNow;
      }
      clearSelectionVisual();
      return;
    }
  }
  // si no coincide, despejar selección
  clearSelectionVisual();
}

/* mostrar solución: resaltar ubicaciones de todas las palabras */
function revealSolution(show=true){
  // primero quitar cualquier selección
  clearSelectionVisual();
  // quitar found temporal
  document.querySelectorAll('td.found').forEach(td => td.classList.remove('found'));
  if(show){
    for(const item of placement){
      let r = item.r0, c = item.c0;
      for(let k=0;k<item.word.length;k++){
        const cell = document.querySelector(`td[data-r="${r}"][data-c="${c}"]`);
        if(cell) cell.classList.add('found');
        r += item.dr; c += item.dc;
      }
      // marcar en lista
      const li = document.getElementById('li-' + item.word);
      if(li) li.classList.add('found-word');
    }
    document.getElementById('foundCount').textContent = displayWords.length;
  } else {
    // si ocultar, borrar marcas found y recalcular contadas reales (palabras realmente encontradas)
    document.querySelectorAll('td.found').forEach(td => td.classList.remove('found'));
    // quitar marcas de lista que provienen de reveal (no de halladas verdaderas)
    displayWords.forEach(d=>{
      const li = document.getElementById('li-' + normalizeWord(d));
      if(li) li.classList.remove('found-word');
    });
    // no conocemos cuáles fueron encontradas por el usuario, así que generamos de nuevo (más simple)
    generateValid();
  }
}

/* botones */
document.getElementById('newBtn').addEventListener('click', ()=>generateValid());
document.getElementById('revealBtn').addEventListener('click', ()=>{ revealSolution(true); document.getElementById('revealBtn').style.display='none'; document.getElementById('hideBtn').style.display='inline-block'; });
document.getElementById('hideBtn').addEventListener('click', ()=>{ revealSolution(false); document.getElementById('revealBtn').style.display='inline-block'; document.getElementById('hideBtn').style.display='none'; });

/* al cargar: generar por primera vez */
generateValid();

</script>
</body>
</html>

